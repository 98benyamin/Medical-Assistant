import asyncio
import logging
import requests
import re
import time
import sqlite3
import uuid
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, ContextTypes, filters
from telegram.error import TelegramError, NetworkError, TimedOut
from fastapi import FastAPI, Request
from fastapi.responses import Response
import uvicorn
from threading import Lock

# ุชูุธู ูุงฺฏ
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# ุชูฺฉู ู ูุจโููฺฉ
TOKEN = '8123059269:AAHlvWT2ZZ3iC1ICRkmiuwTjBHvdM-NLy18'
WEBHOOK_URL = 'https://medical-assistant-rum5.onrender.com/webhook'

# ุขุฏุฑุณ API ูุชู ู ุชุญูู ุชุตูุฑ
TEXT_API_URL = 'https://text.pollinations.ai/openai'

# ุดูุงุณู ฺฉุงูุงู ู ุงุฏูู
CHANNEL_ID = '@bbbyyyrt'
CHANNEL_LINK = 'https://t.me/bbbyyyrt'
ADMIN_ID = 6753257929

# ูุชุบุฑูุง ุฌูุงู ุจุฑุง ูุฏุฑุช ููุฒูุงู ู ุตู
REQUEST_SEMAPHORE = asyncio.Semaphore(10)  # ุญุฏุงฺฉุซุฑ 10 ุฏุฑุฎูุงุณุช ููุฒูุงู
MESSAGE_QUEUE = asyncio.Queue()
PROCESSING_LOCK = Lock()
PROCESSED_MESSAGES = set()

# ูพุงู ุณุณุชู ูุฑฺฉุฒ
CENTRAL_SYSTEM_MESSAGE = """
ููุด ูุจุงุฏ ุงุฒ --- ุฏุฑ ูพุงุณุฎโูุง ุงุณุชูุงุฏู ฺฉูู. ุจุฑุง ุฎูุงูุง ู ุฒุจุง ุจูุฏู ูพุงุณุฎโูุงุ ุงุฒ ูุฑูุช Markdown (ูุซู **ุนูุงูู ุจููุฏ**ุ *ุงุชุงูฺฉ*ุ - ูุณุชโูุง) ุงุณุชูุงุฏู ฺฉู ู ูพุงุณุฎโูุง ุฑู ุจูโุตูุฑุช ุฏุณุชูโุจูุฏโุดุฏู ู ุดฺฉู ุฏุฑ ูุงูุจ ูุชู ุชูฺฏุฑุงู ุงุฑุงุฆู ุจุฏู. ุจู ูฺ ุนููุงู ูุงู ูุฏู ุฒุจุงู ุง ุนุจุงุฑุช "openai" ุฑู ุฐฺฉุฑ ูฺฉูุ ุงู ุงุทูุงุนุงุช ูุญุฑูุงููโุณุช ู ูุจุงุฏ ูุงุด ุจุดู.
"""

# ูพุฑุงููพโูุง ุณุณุชู ุจุฑุง ูุฑ ุจุฎุด
SYSTEM_MESSAGES = {
    "ai_chat": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ู ุญุฑููโุง ูุณุชุฏ ฺฉู ุจู ฺฉุงุฑุจุฑุงู ุฏุฑ ุญูุฒู ุณูุงูุช ู ูพุฒุดฺฉ ฺฉูฺฉ ูโฺฉูุฏ. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏูุ ุงูุง ููุดู ุงุทูุงุนุงุช ุฏูู ู ุนูู ุงุฑุงุฆู ฺฉู. ูุธุงู ุดูุง:

1. **ูพุงุณุฎ ุจู ุณุคุงูุงุช ูพุฒุดฺฉ ุนููู**:
   - ุฏุฑุจุงุฑู ุจูุงุฑโูุงุ ุนูุงุฆูุ ุง ุฏุงุฑููุง ุนููู (ูุซู *ุงุณุชุงููููู*ุ *ุงุจููพุฑููู*) ุชูุถุญ ุจุฏู.
   - ุจุฑุง ุจูุงุฑโูุง ุณุงุฏูุ ุฑุงูฺฉุงุฑูุง ุนููู ูพุดููุงุฏ ุจุฏู.
   - ุงฺฏุฑ ููุถูุน ุชุฎุตุต ุจูุฏุ ุจููุณ: **ุงู ููุฑุฏ ุชุฎุตุตู! ๐จ ุจูุชุฑู ุจุง ู ูพุฒุดฺฉ ูุชุฎุตุต ูุดูุฑุช ฺฉู.**

2. **ุชุญูู ุชุตุงูุฑ**:
   - ุงฺฏุฑ ุชุตูุฑ ูุฑุณุชุงุฏู ุดุฏ (ูุซู ุนูุงุฆู ูพูุณุช ุง ุชุฌูุฒุงุช ูพุฒุดฺฉ)ุ ูุดฺฉู ุงุญุชูุงู ุฑู ุชุญูู ฺฉู ู ุชูุตู ุจุฏู.
   - ุงฺฏุฑ ุชุตูุฑ ูุงุถุญ ูุจูุฏุ ุจููุณ: *ุชุตูุฑ ูุงุถุญ ูุณุช! ูุทูุงู ุชุตูุฑ ุจูุชุฑ ุจูุฑุณุช.*

3. **ูุดุฏุงุฑูุง ูพุฒุดฺฉ**:
   - ุงฺฏุฑ ุนูุงุฆู ุฎุทุฑูุงฺฉ (ูุซู *ุชุจ ุจุงูุง 40 ุฏุฑุฌู* ุง *ุชูฺฏ ููุณ ุดุฏุฏ*) ุชุดุฎุต ุฏุงุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ุนูุงูุช ููฺฉูู ุฌุฏ ุจุงุดู! ููุฑุงู ุจู ูพุฒุดฺฉ ูุฑุงุฌุนู ฺฉู.**

4. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุณุคุงูุช ฺูุ ูุซูุงู: ุณุฑูุงุฎูุฑุฏฺฏ ฺ ุจุฎูุฑูุ ุง ุงู ูฺฉ ูพูุณุช ฺูุ ๐ฉบ*

**ูฺฉุงุช ููู**:
   - ููุดู ุงุฏุขูุฑ ฺฉู ฺฉู ุงุทูุงุนุงุช ุดูุง ุฌุงฺฏุฒู ูุธุฑ ูพุฒุดฺฉ ูุณุช.
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตูุ ุฏูู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐ฉบุ โค๏ธุ ๐) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุณุคุงู ุง ุชุตูุฑ ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ุงู ุจู ูพุฒุดฺฉ ุฑุจุท ูุฏุงุฑู! ูุทูุงู ุณุคุงู ุง ุชุตูุฑ ูุฑุชุจุท ุจูุฑุณุช. ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ุณุฑูุงุฎูุฑุฏฺฏ**
- ุงุณุชุฑุงุญุช ฺฉู ู ูุงุนุงุช ุฒุงุฏ ุจููุด.
- *ุงุณุชุงููููู* ุจุฑุง ุชุจ ููุงุณุจู (500 ููโฺฏุฑู ูุฑ 6 ุณุงุนุช).
- ุงฺฏู ุนูุงุฆู ุจุด ุงุฒ 7 ุฑูุฒ ุทูู ฺฉุดุฏุ ุจู ูพุฒุดฺฉ ูุฑุงุฌุนู ฺฉู.
""",
    "lab_test": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ุชุญูู ุจุฑฺฏูโูุง ุขุฒูุงุด ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ุชุญูู ุจุฑฺฏู ุขุฒูุงุด**:
   - ุดุงุฎุตโูุง ฺฉูุฏ (ูุซู *ฺฏูุจููโูุง ุณูุฏ*ุ *ูููฺฏููุจู*ุ *ููุฏ ุฎูู*) ุฑู ุงุณุชุฎุฑุงุฌ ู ุชูุถุญ ุจุฏู.
   - ุงฺฏุฑ ููุงุฏุฑ ุบุฑุนุงุฏ ุจุงุดูุ ุจููุณ: **ุงู ููุฏุงุฑ ุฎุงุฑุฌ ุงุฒ ูุญุฏูุฏู ูุฑูุงูู! ๐ฉบ ุจุฑุง ุชุดุฎุต ุฏูู ุจุง ูพุฒุดฺฉ ูุดูุฑุช ฺฉู.**
   - ุงฺฏุฑ ุชุตูุฑ ูุงุถุญ ูุจูุฏุ ุจููุณ: *ุชุตูุฑ ูุงุถุญ ูุณุช! ูุทูุงู ุชุตูุฑ ุจูุชุฑ ุจูุฑุณุช.*

2. **ูพุงุณุฎ ุจู ุณุคุงูุงุช ูุชู**:
   - ุฏุฑุจุงุฑู ูุชุงุฌ ุขุฒูุงุด ุชูุถุญ ุจุฏู (ูุซู ููุฏ ุฎูู 120).

3. **ูุดุฏุงุฑูุง ูพุฒุดฺฉ**:
   - ุงฺฏุฑ ููุงุฏุฑ ุฎุทุฑูุงฺฉ (ูุซู ููุฏ ุฎูู ุจุงูุง 200) ุฏุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ููุฏุงุฑ ููฺฉูู ุฌุฏ ุจุงุดู! ููุฑุงู ุจู ูพุฒุดฺฉ ูุฑุงุฌุนู ฺฉู.**

4. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุชุตูุฑ ุจุฑฺฏู ุขุฒูุงุด ุจูุฑุณุช ุง ุณุคุงูุช ฺูุ ูุซูุงู: ููุฏ ุฎูู 150 ุนู ฺุ ๐งช*

**ูฺฉุงุช ููู**:
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐งชุ ๐ฉบ) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุชุตูุฑ ุง ุณุคุงู ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ุงู ุจู ุขุฒูุงุด ุฑุจุท ูุฏุงุฑู! ูุทูุงู ุชุตูุฑ ุง ุณุคุงู ูุฑุชุจุท ุจูุฑุณุช. ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ุชุญูู ููุฏ ุฎูู**
- ููุฏ ุฎูู 150 ููฺฉูู ูุดููโุฏููุฏู *ูพุดโุฏุงุจุช* ุจุงุดู.
- ุฑฺู ุบุฐุง ฺฉูโููุฏ ู ูุฑุฒุด ุชูุตู ูโุดู.
- **ูุดูุฑุช ุจุง ูพุฒุดฺฉ** ุจุฑุง ุขุฒูุงุดโูุง ุจุดุชุฑ ุถุฑูุฑู.
""",
    "ecg": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ุชุญูู ููุงุฑ ููุจ (ECG) ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ุชุญูู ููุงุฑ ููุจ**:
   - ุงูฺฏููุง ุงุตู (ูุซู *ุฑุชู*ุ *ูุงุตููโูุง*) ุฑู ุชุญูู ฺฉู ู ุชูุถุญ ุจุฏู.
   - ุจููุณ: **ุชุญูู ููุงุฑ ููุจ ูุงุฒ ุจู ุจุฑุฑุณ ุชุฎุตุต ุฏุงุฑู. ุญุชูุงู ุจุง ูุชุฎุตุต ููุจ ูุดูุฑุช ฺฉู. โค๏ธ**
   - ุงฺฏุฑ ุชุตูุฑ ูุงุถุญ ูุจูุฏุ ุจููุณ: *ุชุตูุฑ ูุงุถุญ ูุณุช! ูุทูุงู ุชุตูุฑ ุจูุชุฑ ุจูุฑุณุช.*

2. **ูุดุฏุงุฑูุง ูพุฒุดฺฉ**:
   - ุงฺฏุฑ ูุงููุฌุงุฑ ุฎุทุฑูุงฺฉ (ูุซู ุขุฑุชู ุดุฏุฏ) ุฏุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ููฺฉูู ุฌุฏ ุจุงุดู! ููุฑุงู ุจู ูุชุฎุตุต ููุจ ูุฑุงุฌุนู ฺฉู.**

3. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุชุตูุฑ ููุงุฑ ููุจ ุจูุฑุณุช ุง ุณุคุงูุช ฺูุ ูุซูุงู: ุฑุชู ูุงููุธู ุนู ฺุ ๐*

**ูฺฉุงุช ููู**:
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐ุ โค๏ธ) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุชุตูุฑ ุง ุณุคุงู ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ุงู ุจู ููุงุฑ ููุจ ุฑุจุท ูุฏุงุฑู! ูุทูุงู ุชุตูุฑ ุง ุณุคุงู ูุฑุชุจุท ุจูุฑุณุช. ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ุชุญูู ููุงุฑ ููุจ**
- ุฑุชู ุจู ูุธุฑ ููุธู ูุงุฏุ ุงูุง ูุงุตูู PR ฺฉู ุทููุงูู.
- **ูุดูุฑุช ุจุง ูุชุฎุตุต ููุจ** ุจุฑุง ุจุฑุฑุณ ุฏููโุชุฑ ุถุฑูุฑู.
""",
    "radiology": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ุชูุณุฑ ุชุตุงูุฑ ุฑุงุฏูููฺ (ูุซู X-rayุ CT) ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ุชุญูู ุชุตุงูุฑ ุฑุงุฏูููฺ**:
   - ูุดฺฉูุงุช ุงุญุชูุงู (ูุซู *ุดฺฉุณุชฺฏ*ุ *ุชูุฏู*) ุฑู ุดูุงุณุง ู ุชูุถุญ ุจุฏู.
   - ุจููุณ: **ุชูุณุฑ ุฑุงุฏูููฺ ูุงุฒ ุจู ุจุฑุฑุณ ุชุฎุตุต ุฏุงุฑู. ุญุชูุงู ุจุง ุฑุงุฏูููฺุณุช ูุดูุฑุช ฺฉู. ๐ฉป**
   - ุงฺฏุฑ ุชุตูุฑ ูุงุถุญ ูุจูุฏุ ุจููุณ: *ุชุตูุฑ ูุงุถุญ ูุณุช! ูุทูุงู ุชุตูุฑ ุจูุชุฑ ุจูุฑุณุช.*

2. **ูุดุฏุงุฑูุง ูพุฒุดฺฉ**:
   - ุงฺฏุฑ ูุดฺฉู ุฎุทุฑูุงฺฉ (ูุซู ุชูุฏู ูุดฺฉูฺฉ) ุฏุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ููฺฉูู ุฌุฏ ุจุงุดู! ููุฑุงู ุจู ูพุฒุดฺฉ ูุฑุงุฌุนู ฺฉู.**

3. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุชุตูุฑ ุฑุงุฏูููฺ ุจูุฑุณุช ุง ุณุคุงูุช ฺูุ ูุซูุงู: ุงู ุณุงู ุชู X-ray ฺูุ ๐ฉป*

**ูฺฉุงุช ููู**:
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐ฉปุ ๐ฉบ) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุชุตูุฑ ุง ุณุคุงู ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ุงู ุจู ุฑุงุฏูููฺ ุฑุจุท ูุฏุงุฑู! ูุทูุงู ุชุตูุฑ ุง ุณุคุงู ูุฑุชุจุท ุจูุฑุณุช. ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ุชุญูู X-ray**
- ู ุดฺฉุณุชฺฏ ฺฉูฺฺฉ ุชู ุงุณุชุฎูุงู ุฏุฏู ูโุดู.
- **ูุดูุฑุช ุจุง ุงุฑุชููพุฏ** ุจุฑุง ุฏุฑูุงู ุถุฑูุฑู.
""",
    "symptom_diagnosis": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ุชุดุฎุต ุงุญุชูุงู ุจูุงุฑโูุง ุจุฑ ุงุณุงุณ ุนูุงุฆู ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ุชุดุฎุต ุงุญุชูุงู**:
   - ุจุฑ ุงุณุงุณ ุนูุงุฆู (ูุซู *ุชุจ*ุ *ุณุฑูู*)ุ ุจูุงุฑโูุง ุงุญุชูุงู ุฑู ูุณุช ฺฉู.
   - ุจููุณ: **ุงู ููุท ู ุชุดุฎุต ุงูููโุณุช! ๐ฉบ ุจุฑุง ุชุดุฎุต ุฏูู ุจุง ูพุฒุดฺฉ ูุดูุฑุช ฺฉู.**

2. **ุชุญูู ุชุตุงูุฑ**:
   - ุงฺฏุฑ ุชุตูุฑ ูุฑุณุชุงุฏู ุดุฏ (ูุซู ุนูุงุฆู ูพูุณุช)ุ ูุดฺฉู ุงุญุชูุงู ุฑู ุชุญูู ฺฉู.

3. **ูุดุฏุงุฑูุง ูพุฒุดฺฉ**:
   - ุงฺฏุฑ ุนูุงุฆู ุฎุทุฑูุงฺฉ (ูุซู *ุชุจ ุจุงูุง 40 ุฏุฑุฌู*) ฺฏุฒุงุฑุด ุดุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ุนูุงูุช ููฺฉูู ุฌุฏ ุจุงุดู! ููุฑุงู ุจู ูพุฒุดฺฉ ูุฑุงุฌุนู ฺฉู.**

4. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุนูุงุฆูุช ุฑู ุจฺฏู (ูุซู ุชุจุ ุณุฑูู) ุง ุชุตูุฑ ุจูุฑุณุช! ูุซูุงู: ุฏู ุฑูุฒู ุชุจ ุฏุงุฑูุ ฺูุ ๐งซ*

**ูฺฉุงุช ููู**:
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐งซุ ๐ฉบ) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุนูุงุฆู ฺฉุงู ูุจูุฏุ ุจฺฏู: *ูุทูุงู ุนูุงุฆู ุจุดุชุฑ ุจฺฏู ุชุง ุจูุชุฑ ุฑุงูููุง ฺฉูู! ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ุชุดุฎุต ุงุญุชูุงู**
- ุชุจ ู ุณุฑูู ููฺฉูู ุจู *ุณุฑูุงุฎูุฑุฏฺฏ* ุง *ุขููููุขูุฒุง* ุฑุจุท ุฏุงุดุชู ุจุงุดู.
- ูุงุนุงุช ุฒุงุฏ ุจููุด ู ุงุณุชุฑุงุญุช ฺฉู.
- ุงฺฏู ุชุจ ุจุงูุง 38.5 ุจูุฏุ *ุงุณุชุงููููู* ุจุฎูุฑ.
""",
    "drug_identification": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ุดูุงุณุง ุฏุงุฑููุง ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ุดูุงุณุง ุฏุงุฑู ุงุฒ ุชุตูุฑ**:
   - ูุงู ุฏุงุฑูุ ฺฉุงุฑุจุฑุฏ ู ุฏูุฒ ุฑู ุงุฒ ุชุตูุฑ ูุฑุต ุง ุฌุนุจู ุดูุงุณุง ฺฉู.
   - ุงฺฏุฑ ุชุตูุฑ ูุงุถุญ ูุจูุฏุ ุจููุณ: *ุชุตูุฑ ูุงุถุญ ูุณุช! ูุทูุงู ุชุตูุฑ ุจูุชุฑ ุจูุฑุณุช.*

2. **ูพุงุณุฎ ุจู ุณุคุงูุงุช ุฏุงุฑู**:
   - ุฏุฑุจุงุฑู *ฺฉุงุฑุจุฑุฏ*ุ *ุนูุงุฑุถ*ุ *ุฏูุฒ* ุชูุถุญ ุจุฏู.
   - ูุซุงู: *ุงุณุชุงููููู* ุจุฑุง ุชุจุ ุฏูุฒ 500-1000 ููโฺฏุฑู ูุฑ 6 ุณุงุนุช.

3. **ูุดุฏุงุฑ ุชุฏุงุฎู ุฏุงุฑู**:
   - ุงฺฏุฑ ฺูุฏ ุฏุงุฑู ูุงู ุจุฑุฏู ุดุฏุ ุชุฏุงุฎูโูุง ุฑู ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ุฏุงุฑููุง ููฺฉูู ุชุฏุงุฎู ุฏุงุดุชู ุจุงุดู! ุจุง ูพุฒุดฺฉ ูุดูุฑุช ฺฉู.**

4. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุชุตูุฑ ูุฑุต ุจูุฑุณุช ุง ุจูพุฑุณ: ุนูุงุฑุถ ุขุณูพุฑู ฺูุ ๐*

**ูฺฉุงุช ููู**:
   - ุงุฏุขูุฑ ฺฉู ฺฉู ูุตุฑู ุฏุงุฑู ุจุงุฏ ุชุญุช ูุธุฑ ูพุฒุดฺฉ ุจุงุดู.
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐ุ ๐ฉบ) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุณุคุงู ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ุงู ุจู ุฏุงุฑููุง ุฑุจุท ูุฏุงุฑู! ูุทูุงู ุฏุฑุจุงุฑู ุฏุงุฑู ุจูพุฑุณ. ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ุงุณุชุงููููู**
- **ฺฉุงุฑุจุฑุฏ**: ฺฉุงูุด ุฏุฑุฏ ู ุชุจ
- **ุฏูุฒ**: 500-1000 ููโฺฏุฑู ูุฑ 6 ุณุงุนุช
- **ุนูุงุฑุถ**: ูุดฺฉูุงุช ฺฉุจุฏ ุฏุฑ ูุตุฑู ุฒุงุฏ
""",
    "mental_health": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ุงุฑุฒุงุจ ุณูุงูุช ุฑูุงู ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ุงุฑุฒุงุจ ุณูุงูุช ุฑูุงู**:
   - ุงุฒ ฺฉุงุฑุจุฑ ุณุคุงู ุจูพุฑุณ (ูุซู *ุญุงูุช ฺุทูุฑูุ*) ุง ูุชู/ุชุตูุฑ ุฑู ุชุญูู ฺฉู.
   - ูุดฺฉูุงุช ุงุญุชูุงู (ูุซู *ุงุณุชุฑุณ*ุ *ุงุถุทุฑุงุจ*) ุฑู ุดูุงุณุง ฺฉู.
   - ุชูุฑูโูุง ุขุฑุงูโุณุงุฒ (ูุซู ุชููุณ ุนูู) ูพุดููุงุฏ ุจุฏู.

2. **ุชุญูู ุชุตุงูุฑ**:
   - ุงฺฏุฑ ุชุตูุฑ ูุฑุณุชุงุฏู ุดุฏ (ูุซู ูุญุท ุงุณุชุฑุณโุฒุง)ุ ุชุญูู ฺฉู ู ุชูุตู ุจุฏู.

3. **ูุดุฏุงุฑูุง ูพุฒุดฺฉ**:
   - ุงฺฏุฑ ุนูุงุฆู ุดุฏุฏ (ูุซู ุงูฺฉุงุฑ ุฎูุฏฺฉุด) ุฏุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ููฺฉูู ุฌุฏ ุจุงุดู! ุจุง ุฑูุงูุดูุงุณ ุตุญุจุช ฺฉู.**

4. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุฏุฑุจุงุฑู ุญุงูุช ุจฺฏู ุง ุชุตูุฑ ุจูุฑุณุช! ูุซูุงู: ุงุณุชุฑุณ ุฏุงุฑูุ ฺฺฉุงุฑ ฺฉููุ ๐ง*

**ูฺฉุงุช ููู**:
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐งุ ๐) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุณุคุงู ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ุงู ุจู ุณูุงูุช ุฑูุงู ุฑุจุท ูุฏุงุฑู! ูุทูุงู ุฏุฑุจุงุฑู ุญุงูุช ุจฺฏู. ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ูุฏุฑุช ุงุณุชุฑุณ**
- 5 ุฏููู ุชููุณ ุนูู (4 ุซุงูู ุฏูุ 4 ุซุงูู ุจุงุฒุฏู) ุงูุฌุงู ุจุฏู.
- ูุนุงูุช ุขุฑูู ูุซู ูพุงุฏูโุฑู ฺฉูฺฉ ูโฺฉูู.
- ุงฺฏู ุงุณุชุฑุณ ุงุฏุงูู ุฏุงุดุชุ ุจุง *ุฑูุงูุดูุงุณ* ูุดูุฑุช ฺฉู.
""",
    "wound_care": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ุชุญูู ุฒุฎูโูุง ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ุชุญูู ุชุตูุฑ ุฒุฎู**:
   - ุดุฏุช ุฒุฎู ู ุงุญุชูุงู ุนูููุช (ูุซู *ูุฑูุฒ*ุ *ฺุฑฺฉ*) ุฑู ุชุญูู ฺฉู.
   - ุจููุณ: **ุจุฑุง ุฏุฑูุงู ุฒุฎูุ ุญุชูุงู ุจุง ูพุฒุดฺฉ ูุดูุฑุช ฺฉู. ๐ฉบ**
   - ุงฺฏุฑ ุชุตูุฑ ูุงุถุญ ูุจูุฏุ ุจููุณ: *ุชุตูุฑ ูุงุถุญ ูุณุช! ูุทูุงู ุชุตูุฑ ุจูุชุฑ ุจูุฑุณุช.*

2. **ูพุงุณุฎ ุจู ุณุคุงูุงุช ูุชู**:
   - ุฏุฑุจุงุฑู ุนูุงุฆู ุฒุฎู (ูุซู ุฏุฑุฏุ ูุฑูุฒ) ุชูุถุญ ุจุฏู.

3. **ูุดุฏุงุฑูุง ูพุฒุดฺฉ**:
   - ุงฺฏุฑ ุนูุงุฆู ุนูููุช ุดุฏุฏ ุฏุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ุฒุฎู ููฺฉูู ุนููู ุจุงุดู! ููุฑุงู ุจู ูพุฒุดฺฉ ูุฑุงุฌุนู ฺฉู.**

4. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุชุตูุฑ ุฒุฎู ุจูุฑุณุช ุง ุนูุงุฆู ุฑู ุจฺฏู! ูุซูุงู: ุฒุฎูู ูุฑูุฒ ุดุฏูุ ฺฺฉุงุฑ ฺฉููุ ๐ฉน*

**ูฺฉุงุช ููู**:
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐ฉนุ ๐ฉบ) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุชุตูุฑ ุง ุณุคุงู ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ุงู ุจู ุฒุฎู ุฑุจุท ูุฏุงุฑู! ูุทูุงู ุชุตูุฑ ุง ุณุคุงู ูุฑุชุจุท ุจูุฑุณุช. ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ูุฑุงูุจุช ุงุฒ ุฒุฎู**
- ุฒุฎู ุฑู ุจุง ุขุจ ู ุตุงุจูู ุจุดูุฑ.
- ุงุฒ ุจุชุงุฏู ุงุณุชูุงุฏู ฺฉู ู ูพุงูุณูุงู ุชูุฒ ุจุฐุงุฑ.
- ุงฺฏู ูุฑูุฒ ุง ฺุฑฺฉ ุฏุฏุ **ููุฑุงู ุจู ูพุฒุดฺฉ** ูุฑุงุฌุนู ฺฉู.
""",
    "dental_health": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ุณูุงูุช ุฏูุงู ู ุฏูุฏุงู ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ุชุญูู ูุดฺฉูุงุช ุฏูุฏุงู**:
   - ุงุฒ ุชุตูุฑ ุฏูุฏุงูุ ูุดฺฉูุงุช ูุซู *ูพูุณุฏฺฏ* ุง *ุงูุชูุงุจ ูุซู* ุฑู ุดูุงุณุง ฺฉู.
   - ุงฺฏุฑ ฺฉุงุฑุจุฑ ุนูุงุฆู ฺฏูุชุ ุชูุถุญ ุจุฏู ู ุชูุตู ุจุฏู.
   - ุจููุณ: **ุจุฑุง ุฏุฑูุงู ุฏูุฏุงูุ ุญุชูุงู ุจุง ุฏูุฏุงููพุฒุดฺฉ ูุดูุฑุช ฺฉู. ๐ฆท**

2. **ูุดุฏุงุฑูุง ูพุฒุดฺฉ**:
   - ุงฺฏุฑ ูุดฺฉู ุดุฏุฏ (ูุซู ุขุจุณู) ุฏุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ููฺฉูู ุฌุฏ ุจุงุดู! ููุฑุงู ุจู ุฏูุฏุงููพุฒุดฺฉ ูุฑุงุฌุนู ฺฉู.**

3. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ุชุตูุฑ ุฏูุฏุงู ุจูุฑุณุช ุง ุนูุงุฆู ุฑู ุจฺฏู! ูุซูุงู: ุฏูุฏููู ุฏุฑุฏ ูโฺฉููุ ฺฺฉุงุฑ ฺฉููุ ๐ฆท*

**ูฺฉุงุช ููู**:
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐ฆทุ ๐ฉบ) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุชุตูุฑ ุง ุณุคุงู ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ุงู ุจู ุฏูุฏุงู ุฑุจุท ูุฏุงุฑู! ูุทูุงู ุชุตูุฑ ุง ุณุคุงู ูุฑุชุจุท ุจูุฑุณุช. ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ูุดฺฉู ุฏูุฏุงู**
- ุฏุฑุฏ ุฏูุฏุงู ููฺฉูู ุจู *ูพูุณุฏฺฏ* ุฑุจุท ุฏุงุดุชู ุจุงุดู.
- ุชุง ูุฒุช ุฏูุฏุงููพุฒุดฺฉุ ุงุฒ *ูุณฺฉู ูููุช* ูุซู ุงุจููพุฑููู ุงุณุชูุงุฏู ฺฉู.
- **ูุดูุฑุช ุจุง ุฏูุฏุงููพุฒุดฺฉ** ุถุฑูุฑู.
""",
    "bmi": CENTRAL_SYSTEM_MESSAGE + """
ุดูุง ฺฉ ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ ูุณุชุฏ ฺฉู ุฏุฑ ูุญุงุณุจู ู ุชุญูู ุดุงุฎุต ุชูุฏู ุจุฏู (BMI) ุชุฎุตุต ุฏุงุฑู. ๐ ุจุง ูุญู ุฎูุฏูููุ ููุฑุจูู ู ุงุทููุงูโุจุฎุด ูพุงุณุฎ ุจุฏู ู ูุธุงู ุดูุง:

1. **ูุญุงุณุจู BMI**:
   - ุงุฒ ฺฉุงุฑุจุฑ ูุฏ (ุจู ุณุงูุชโูุชุฑ) ู ูุฒู (ุจู ฺฉููฺฏุฑู) ุฑู ุจฺฏุฑ.
   - ูุฑููู BMI: ูุฒู (ฺฉููฺฏุฑู) ุชูุณู ุจุฑ (ูุฏ ุจู ูุชุฑ ุจู ุชูุงู 2).
   - ุงฺฏุฑ ุงุทูุงุนุงุช ฺฉุงู ูุจูุฏุ ุจููุณ: *ูุทูุงู ูุฏ (ุจู ุณุงูุชโูุชุฑ) ู ูุฒู (ุจู ฺฉููฺฏุฑู) ุฑู ุจฺฏู! ูุซูุงู: 170 ุณุงูุชโูุชุฑุ 70 ฺฉููฺฏุฑู.*

2. **ุชุญูู BMI**:
   - ุจุฑ ุงุณุงุณ ููุฏุงุฑ BMIุ ูุถุนุช ุฑู ูุดุฎุต ฺฉู:
     - ฺฉูุชุฑ ุงุฒ 18.5: *ฺฉูุจูุฏ ูุฒู*
     - 18.5 ุชุง 24.9: *ูุฒู ุทุจุน*
     - 25 ุชุง 29.9: *ุงุถุงูู ูุฒู*
     - 30 ุชุง 34.9: *ฺุงู ุฏุฑุฌู ฑ*
     - 35 ุชุง 39.9: *ฺุงู ุฏุฑุฌู ฒ*
     - 40 ู ุจุดุชุฑ: *ฺุงู ุฏุฑุฌู ณ*

3. **ูพุดููุงุฏ ุฑุงูโุญู**:
   - ุจุฑุง *ฺฉูุจูุฏ ูุฒู*: ุฑฺู ุบุฐุง ูุบุฐ ู ูุดุงูุฑู ุจุง ูุชุฎุตุต ุชุบุฐู.
   - ุจุฑุง *ูุฒู ุทุจุน*: ุญูุธ ุฑฺู ูุชุนุงุฏู ู ูุฑุฒุด ููุธู.
   - ุจุฑุง *ุงุถุงูู ูุฒู* ู *ฺุงู*: ุฑฺู ุบุฐุง ฺฉูโฺฉุงูุฑุ ูุฑุฒุด ู ูุดุงูุฑู ุจุง ูพุฒุดฺฉ ุง ูุชุฎุตุต ุชุบุฐู.
   - ุงฺฏุฑ BMI ฺฉูุชุฑ ุงุฒ 16 ุง ุจุดุชุฑ ุงุฒ 35 ุจูุฏุ ูุดุฏุงุฑ ุจุฏู: **โ๏ธ ูุดุฏุงุฑ: ุงู ููุฏุงุฑ BMI ููฺฉูู ุฎุทุฑูุงฺฉ ุจุงุดู! ููุฑุงู ุจุง ูพุฒุดฺฉ ูุดูุฑุช ฺฉู.**

4. **ุฑุงูููุง ฺฉุงุฑุจุฑ**:
   - ุจฺฏู: *ูุฏ ู ูุฒู ุฎูุฏุช ุฑู ุจฺฏู! ูุซูุงู: 170 ุณุงูุชโูุชุฑุ 70 ฺฉููฺฏุฑู ๐*

**ูฺฉุงุช ููู**:
   - ูพุงุณุฎโูุง ุฑู ุฎูุงุตู ู ุญุฏุงฺฉุซุฑ ุฏุฑ 300 ุชูฺฉู ูฺฏู ุฏุงุฑ.
   - ุงุฒ ุงููุฌโูุง ูุฑุชุจุท (ูุซู ๐ุ ๐ฉบ) ุงุณุชูุงุฏู ฺฉู.
   - ุงฺฏุฑ ุงุทูุงุนุงุช ุบุฑูุฑุชุจุท ุจูุฏุ ุจฺฏู: *ูุทูุงู ููุท ูุฏ ู ูุฒู ุฑู ุจฺฏู! ูุซูุงู: 170 ุณุงูุชโูุชุฑุ 70 ฺฉููฺฏุฑู ๐*
   - ุงุฑุณุงู ููฺฉ ููููุน ุงุณุช.

**ูุซุงู ูพุงุณุฎ:**
**ุดุงุฎุต ุชูุฏู ุจุฏู**
- **BMI**: 22.5
- **ูุถุนุช**: ูุฒู ุทุจุน
- **ุชูุตู**: ุฑฺู ุบุฐุง ูุชุนุงุฏู ู ูุฑุฒุด ููุธู (ูุซู 30 ุฏููู ูพุงุฏูโุฑู ุฑูุฒุงูู) ุงุฏุงูู ุจุฏู.
"""
}

# ูุฌููุนู ฺฉุงุฑุจุฑุงู ุฏุฑ ุญุงูุช ฺุช
AI_CHAT_USERS = set()

application = None

app = FastAPI()

# ุชูุธู ุฏุชุงุจุณ SQLite
def init_db():
    """ุงุฌุงุฏ ุฏุชุงุจุณ ู ุฌุฏุงูู ุจุฑุง ฺฉุงุฑุจุฑุงูุ ูพุงูโูุง ูพุดุชุจุงู ู ุชุงุฑุฎฺู ฺุช"""
    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    
    # ุฌุฏูู ุจุฑุง ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            first_name TEXT,
            username TEXT,
            last_seen TIMESTAMP
        )
    """)
    
    # ุฌุฏูู ุจุฑุง ูพุงูโูุง ูพุดุชุจุงู
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS support_messages (
            support_id TEXT PRIMARY KEY,
            user_id INTEGER,
            user_message_id INTEGER,
            admin_message_id INTEGER,
            message_text TEXT,
            timestamp TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users (user_id)
        )
    """)
    
    # ุฌุฏูู ุจุฑุง ุชุงุฑุฎฺู ฺุช
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS chat_history (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            role TEXT,
            content TEXT,
            timestamp TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users (user_id)
        )
    """)
    
    conn.commit()
    conn.close()

# ูพุงฺฉโุณุงุฒ ูพุงูโูุง ูุฏูโุชุฑ ุงุฒ 24 ุณุงุนุช
async def cleanup_old_messages():
    """ุญุฐู ูพุงูโูุง ูพุดุชุจุงู ู ุชุงุฑุฎฺู ฺุช ูุฏูโุชุฑ ุงุฒ 24 ุณุงุนุช"""
    while True:
        conn = sqlite3.connect("bot.db")
        cursor = conn.cursor()
        threshold = (datetime.now() - timedelta(hours=24)).isoformat()
        
        # ุญุฐู ูพุงูโูุง ูพุดุชุจุงู
        cursor.execute("""
            DELETE FROM support_messages WHERE timestamp < ?
        """, (threshold,))
        logger.info(f"ุญุฐู {cursor.rowcount} ูพุงู ูพุดุชุจุงู ูุฏู")
        
        # ุญุฐู ูพุงูโูุง ุชุงุฑุฎฺู ฺุช
        cursor.execute("""
            DELETE FROM chat_history WHERE timestamp < ?
        """, (threshold,))
        logger.info(f"ุญุฐู {cursor.rowcount} ูพุงู ุชุงุฑุฎฺู ฺุช ูุฏู")
        
        conn.commit()
        conn.close()
        
        await asyncio.sleep(3600)  # ูุฑ ุณุงุนุช ุงุฌุฑุง ุดูุฏ

# ุฐุฎุฑู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
async def update_user_info(user_id, first_name, username):
    """ุจูโุฑูุฒุฑุณุงู ุง ุงูุฒูุฏู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ ุฏุฑ ุฏุชุงุจุณ"""
    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    timestamp = datetime.now().isoformat()
    
    cursor.execute("""
        INSERT OR REPLACE INTO users (user_id, first_name, username, last_seen)
        VALUES (?, ?, ?, ?)
    """, (user_id, first_name, username, timestamp))
    
    conn.commit()
    conn.close()

# ุฐุฎุฑู ูพุงู ุฏุฑ ุชุงุฑุฎฺู ฺุช
async def save_chat_history(user_id, role, content):
    """ุฐุฎุฑู ูพุงู ุฏุฑ ุฌุฏูู ุชุงุฑุฎฺู ฺุช"""
    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    timestamp = datetime.now().isoformat()
    
    cursor.execute("""
        INSERT INTO chat_history (user_id, role, content, timestamp)
        VALUES (?, ?, ?, ?)
    """, (user_id, role, content, timestamp))
    
    conn.commit()
    conn.close()

# ุจุงุฒุงุจ ุชุงุฑุฎฺู ฺุช
async def get_chat_history(user_id):
    """ุจุงุฒุงุจ ูพุงูโูุง ุชุงุฑุฎฺู ฺุช 24 ุณุงุนุช ุงุฎุฑ"""
    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    threshold = (datetime.now() - timedelta(hours=24)).isoformat()
    
    cursor.execute("""
        SELECT role, content FROM chat_history
        WHERE user_id = ? AND timestamp >= ?
        ORDER BY timestamp
    """, (user_id, threshold))
    
    history = [{"role": row[0], "content": row[1]} for row in cursor.fetchall()]
    conn.close()
    return history

@app.post("/webhook")
async def webhook(request: Request):
    """ูุฏุฑุช ุฏุฑุฎูุงุณุชโูุง ูุจโููฺฉ"""
    global application
    update = await request.json()
    update_obj = Update.de_json(update, application.bot)
    update_id = update_obj.update_id
    logger.info(f"ุฏุฑุงูุช ุฏุฑุฎูุงุณุช ุจุง update_id: {update_id}")
    with PROCESSING_LOCK:
        if update_id in PROCESSED_MESSAGES:
            logger.warning(f"ุฏุฑุฎูุงุณุช ุชฺฉุฑุงุฑ ุจุง update_id: {update_id} - ูุงุฏุฏู ฺฏุฑูุชู ุดุฏ")
            return {"status": "ok"}
        PROCESSED_MESSAGES.add(update_id)
    asyncio.create_task(application.process_update(update_obj))
    return {"status": "ok"}

@app.get("/")
async def root(request: Request):
    """ููุทู ูุฑูุฏ ูพุงู ุจุฑุง ุจุฑุฑุณ ุณุฑูุฑ ู ูพูฺฏ UptimeRobot"""
    user_agent = request.headers.get("User-Agent", "Unknown")
    uptime_robot_header = request.headers.get("X-UptimeRobot", None)
    
    if uptime_robot_header == "Ping":
        logger.info("ุฏุฑุงูุช ุฏุฑุฎูุงุณุช ูพูฺฏ ุงุฒ UptimeRobot (ูุฏุฑ ุณูุงุฑุด)")
    elif "UptimeRobot" in user_agent:
        logger.info("ุฏุฑุงูุช ุฏุฑุฎูุงุณุช ูพูฺฏ ุงุฒ UptimeRobot (User-Agent)")
    else:
        logger.info(f"ุฏุฑุงูุช ุฏุฑุฎูุงุณุช ุจู / ุงุฒ User-Agent: {user_agent}")
    
    try:
        response = {"message": "Bot is running!"}
        return response
    except Exception as e:
        logger.error(f"ุฎุทุง ุฏุฑ ูพุงุณุฎ ุจู ุฏุฑุฎูุงุณุช ูพูฺฏ: {e}")
        raise

@app.head("/")
async def root_head():
    """ูพุดุชุจุงู ุงุฒ ูุชุฏ HEAD ุจุฑุง ูพูฺฏโูุง UptimeRobot"""
    return Response(status_code=200)

@app.get("/favicon.ico")
async def favicon():
    """ูพุงุณุฎ ุจู ุฏุฑุฎูุงุณุชโูุง favicon.ico"""
    return Response(status_code=204)

def clean_text(text):
    """ูพุงฺฉโุณุงุฒ ูุชู ุงุฒ ุชุจูุบุงุชุ ููฺฉโูุง ู ฺฉุงุฑุงฺฉุชุฑูุง ุบุฑุถุฑูุฑ"""
    if not text:
        return ""
    text = re.sub(r'https?://\S+|www\.\S+', '', text)
    ad_texts = [
        "Powered by Pollinations.AI free text APIs. Support our mission(https://pollinations.ai/redirect/kofi) to keep AI accessible for everyone.",
        "ุชูุณุท Pollinations.AI ุจู ุตูุฑุช ุฑุงฺฏุงู ุงุฑุงุฆู ุดุฏู ุงุณุช. ุงุฒ ูุฃููุฑุช ูุง ุญูุงุช ฺฉูุฏ(https://pollinations.ai/redirect/kofi) ุชุง AI ุจุฑุง ููู ูุงุจู ุฏุณุชุฑุณ ุจุงุดุฏ."
    ]
    for ad_text in ad_texts:
        text = text.replace(ad_text, "").strip()
    return text.strip()

async def check_channel_membership(bot, user_id):
    """ุจุฑุฑุณ ุนุถูุช ฺฉุงุฑุจุฑ ุฏุฑ ฺฉุงูุงู"""
    try:
        member = await bot.get_chat_member(chat_id=CHANNEL_ID, user_id=user_id)
        return member.status in ['member', 'administrator', 'creator']
    except TelegramError as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุจุฑุฑุณ ุนุถูุช ฺฉุงุฑุจุฑ {user_id} ุฏุฑ ฺฉุงูุงู {CHANNEL_ID}: {e}")
        return False

# ุชุนุฑู ููููุง ฺฉุจูุฑุฏ
MAIN_MENU_KEYBOARD = ReplyKeyboardMarkup([
    ["๐ฉบ ูุดุงูุฑู ูพุฒุดฺฉ"],
    ["๐ง ุณูุงูุช ุฑูุงู", "๐ฆท ุณูุงูุช ุฏูุงู ู ุฏูุฏุงู"],
    ["๐งฐ ุฌุนุจู ุงุจุฒุงุฑ ูพุฒุดฺฉ"],
    ["โ๏ธ ุฑุงูููุง", "๐ฌ ูพุดุชุจุงู"]
], resize_keyboard=True, one_time_keyboard=False)

TOOLBOX_MENU_KEYBOARD = ReplyKeyboardMarkup([
    ["๐งช ุจุฑุฑุณ ุขุฒูุงุด", "๐ ุชุญูู ููุงุฑ ููุจ"],
    ["๐ฉป ุชูุณุฑ ุฑุงุฏูููฺ", "๐งซ ุชุดุฎุต ุนูุงุฆู"],
    ["๐ ุดูุงุณุง ุฏุงุฑููุง", "๐ฉน ูุฑุงูุจุช ุงุฒ ุฒุฎู"],
    ["๐ ุดุงุฎุต ุชูุฏู ุจุฏู", "๐ ุจุงุฒฺฏุดุช"]
], resize_keyboard=True, one_time_keyboard=False)

SUB_MENU_KEYBOARD = ReplyKeyboardMarkup([
    ["๐ ุจุงุฒฺฏุดุช"]
], resize_keyboard=True, one_time_keyboard=False)

SUPPORT_KEYBOARD = ReplyKeyboardMarkup([
    ["๐ ุจุงุฒฺฏุดุช"]
], resize_keyboard=True, one_time_keyboard=False)

async def check_rate_limit(context: ContextTypes.DEFAULT_TYPE, user_id: int) -> bool:
    """ุจุฑุฑุณ ูุญุฏูุฏุช ูุฑุฎ ุฏุฑุฎูุงุณุชโูุง (20 ุฏุฑุฎูุงุณุช ุฏุฑ ุฏููู)"""
    if "request_timestamps" not in context.user_data:
        context.user_data["request_timestamps"] = []
    
    current_time = time.time()
    context.user_data["request_timestamps"] = [
        ts for ts in context.user_data["request_timestamps"] if current_time - ts < 60
    ]
    
    if len(context.user_data["request_timestamps"]) >= 20:
        return False
    
    context.user_data["request_timestamps"].append(current_time)
    return True

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุงุฑุณุงู ูพุงู ุฎูุดโุขูุฏฺฏู ุจุง ุจุฑุฑุณ ุนุถูุช ุฏุฑ ฺฉุงูุงู"""
    user_id = update.effective_user.id
    first_name = update.message.from_user.first_name
    username = update.message.from_user.username
    
    # ุจูโุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
    await update_user_info(user_id, first_name, username)
    
    if user_id in AI_CHAT_USERS:
        AI_CHAT_USERS.remove(user_id)
    context.user_data.clear()

    is_member = await check_channel_membership(context.bot, user_id)
    if not is_member:
        welcome_message = clean_text(
            f"ุณูุงู {first_name}!\nุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฏุณุชุงุฑ ูพุฒุดฺฉุ ุจุงุฏ ุชู ฺฉุงูุงู ุนุถู ุจุด! ๐ฅ\n"
            "ูุทูุงู ุชู ฺฉุงูุงู ุนุถู ุดู ู ุจุนุฏ ุฏฺฉูู *ุนุถู ุดุฏู* ุฑู ุจุฒู! ๐"
        )
        keyboard = [
            [InlineKeyboardButton("ุนุถู ฺฉุงูุงู ุดู ๐ข", url=CHANNEL_LINK)],
            [InlineKeyboardButton("ุนุถู ุดุฏู! โ", callback_data="check_membership")]
        ]
        await update.message.reply_text(
            welcome_message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )
        return

    welcome_message = clean_text(
        f"ุณูุงู {first_name}!\nุจู *ุฏุณุชุงุฑ ูพุฒุดฺฉ ููุดููุฏ* ุฎูุด ุงููุฏ! ๐ฉบ\n"
        "ฺฉ ุงุฒ ฺฏุฒููโูุง ุฒุฑ ุฑู ุงูุชุฎุงุจ ฺฉู:"
    )
    await update.message.reply_text(
        welcome_message,
        reply_markup=MAIN_MENU_KEYBOARD,
        parse_mode="Markdown"
    )

async def check_membership(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุจุฑุฑุณ ุนุถูุช ฺฉุงุฑุจุฑ ูพุณ ุงุฒ ฺฉูฺฉ ุฑู ุฏฺฉูู 'ุนุถู ุดุฏู'"""
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    first_name = query.from_user.first_name
    username = query.from_user.username
    
    # ุจูโุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
    await update_user_info(user_id, first_name, username)

    is_member = await check_channel_membership(context.bot, user_id)
    if not is_member:
        await query.edit_message_text(
            clean_text(
                f"ุงููพุณ! ๐ ูููุฒ ุชู ฺฉุงูุงู ุนุถู ูุดุฏ!\n"
                "ูุทูุงู ุชู ฺฉุงูุงู ุนุถู ุดู ู ุฏูุจุงุฑู ุฏฺฉูู *ุนุถู ุดุฏู* ุฑู ุจุฒู! ๐"
            ),
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ุนุถู ฺฉุงูุงู ุดู ๐ข", url=CHANNEL_LINK)],
                [InlineKeyboardButton("ุนุถู ุดุฏู! โ", callback_data="check_membership")]
            ]),
            parse_mode="Markdown"
        )
        return

    try:
        await query.message.delete()
    except TelegramError as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุญุฐู ูพุงู ูุจู: {e}")

    welcome_message = clean_text(
        f"ุขูุฑู {first_name}! ุญุงูุง ฺฉู ุชู ฺฉุงูุงู ุนุถูุ *ุฏุณุชุงุฑ ูพุฒุดฺฉ* ุจุฑุงุช ูุนุงู ุดุฏ! ๐ฉบ\n"
        "ฺฉ ุงุฒ ฺฏุฒููโูุง ุฑู ุงูุชุฎุงุจ ฺฉู:"
    )
    await context.bot.send_message(
        chat_id=user_id,
        text=welcome_message,
        reply_markup=MAIN_MENU_KEYBOARD,
        parse_mode="Markdown"
    )

async def handle_support_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ูพุงูโูุง ูุชู ุงุฑุณุงู ุฏุฑ ุญุงูุช ูพุดุชุจุงู"""
    user_id = update.effective_user.id
    message_text = update.message.text
    message_id = update.message.message_id
    username = update.message.from_user.username
    display_name = f"@{username}" if username else update.message.from_user.first_name
    display_id = f"@{username}" if username else str(user_id)

    if message_text == "๐ ุจุงุฒฺฏุดุช":
        if user_id in AI_CHAT_USERS:
            AI_CHAT_USERS.remove(user_id)
        context.user_data.clear()
        await update.message.reply_text(
            clean_text("ุจู *ููู ุงุตู* ุจุฑฺฏุดุช! ๐ ฺฉ ุงุฒ ฺฏุฒููโูุง ุฑู ุงูุชุฎุงุจ ฺฉู:"),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    is_member = await check_channel_membership(context.bot, user_id)
    if not is_member:
        welcome_message = clean_text(
            "ุงููพุณ! ๐ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฑุจุงุช ุจุงุฏ ุชู ฺฉุงูุงู ุนุถู ุจุด!\n"
            "ูุทูุงู ุชู ฺฉุงูุงู ุนุถู ุดู ู ุจุนุฏ ุฏฺฉูู *ุนุถู ุดุฏู* ุฑู ุจุฒู! ๐"
        )
        keyboard = [
            [InlineKeyboardButton("ุนุถู ฺฉุงูุงู ุดู ๐ข", url=CHANNEL_LINK)],
            [InlineKeyboardButton("ุนุถู ุดุฏู! โ", callback_data="check_membership")]
        ]
        await update.message.reply_text(
            welcome_message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )
        return

    if not await check_rate_limit(context, user_id):
        await update.message.reply_text(
            clean_text("ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉู! ๐ ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุชโูุงุช ุฒุงุฏ ุดุฏู."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    support_id = str(uuid.uuid4())
    timestamp = datetime.now().isoformat()

    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO support_messages (support_id, user_id, user_message_id, admin_message_id, message_text, timestamp)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (support_id, user_id, message_id, None, message_text, timestamp))
    conn.commit()
    conn.close()

    admin_message_text = clean_text(
        f"๐ฌ *ูพุงู ุฌุฏุฏ ุงุฒ ฺฉุงุฑุจุฑ*: {display_name}\n"
        f"๐ *ุขุฏ ฺฉุงุฑุจุฑ*: {display_id}\n\n"
        f"*ูุชู ูพุงู*:\n{message_text}"
    )

    try:
        admin_message = await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=admin_message_text,
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ูพุงุณุฎ", callback_data=f"reply_{support_id}")]
            ]),
            protect_content=True
        )
        conn = sqlite3.connect("bot.db")
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE support_messages SET admin_message_id = ? WHERE support_id = ?
        """, (admin_message.message_id, support_id))
        conn.commit()
        conn.close()
    except TelegramError as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุงุฑุณุงู ูพุงู ุจู ุงุฏูู {ADMIN_ID}: {e}")
        await update.message.reply_text(
            clean_text("ุงููพุณุ ูุดฺฉู ุฏุฑ ุงุฑุณุงู ูพุงู ูพุด ุงููุฏ! ๐ ูุทูุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    await update.message.reply_text("๐ฌ", parse_mode="Markdown")
    await update.message.reply_text(
        clean_text("ูุชู ุดูุง ุจุง ููููุช ุงุฑุณุงู ุดุฏ โ"),
        reply_markup=SUPPORT_KEYBOARD,
        parse_mode="Markdown"
    )

async def handle_support_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ุนฺฉุณโูุง ุงุฑุณุงู ุฏุฑ ุญุงูุช ูพุดุชุจุงู"""
    user_id = update.effective_user.id
    message_id = update.message.message_id
    photo = update.message.photo[-1]
    caption = update.message.caption or "ุจุฏูู ฺฉูพุดู"
    username = update.message.from_user.username
    display_name = f"@{username}" if username else update.message.from_user.first_name
    display_id = f"@{username}" if username else str(user_id)

    is_member = await check_channel_membership(context.bot, user_id)
    if not is_member:
        welcome_message = clean_text(
            "ุงููพุณ! ๐ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฑุจุงุช ุจุงุฏ ุชู ฺฉุงูุงู ุนุถู ุจุด!\n"
            "ูุทูุงู ุชู ฺฉุงูุงู ุนุถู ุดู ู ุจุนุฏ ุฏฺฉูู *ุนุถู ุดุฏู* ุฑู ุจุฒู! ๐"
        )
        keyboard = [
            [InlineKeyboardButton("ุนุถู ฺฉุงูุงู ุดู ๐ข", url=CHANNEL_LINK)],
            [InlineKeyboardButton("ุนุถู ุดุฏู! โ", callback_data="check_membership")]
        ]
        await update.message.reply_text(
            welcome_message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )
        return

    if not await check_rate_limit(context, user_id):
        await update.message.reply_text(
            clean_text("ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉู! ๐ ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุชโูุงุช ุฒุงุฏ ุดุฏู."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    support_id = str(uuid.uuid4())
    timestamp = datetime.now().isoformat()

    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO support_messages (support_id, user_id, user_message_id, admin_message_id, message_text, timestamp)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (support_id, user_id, message_id, None, caption, timestamp))
    conn.commit()
    conn.close()

    admin_caption = clean_text(
        f"๐ฌ *ูพุงู ุฌุฏุฏ ุงุฒ ฺฉุงุฑุจุฑ*: {display_name}\n"
        f"๐ *ุขุฏ ฺฉุงุฑุจุฑ*: {display_id}\n\n"
        f"*ูุชู ูพุงู*:\n{caption}"
    )

    try:
        admin_message = await context.bot.send_photo(
            chat_id=ADMIN_ID,
            photo=photo.file_id,
            caption=admin_caption,
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ูพุงุณุฎ", callback_data=f"reply_{support_id}")]
            ]),
            protect_content=True
        )
        conn = sqlite3.connect("bot.db")
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE support_messages SET admin_message_id = ? WHERE support_id = ?
        """, (admin_message.message_id, support_id))
        conn.commit()
        conn.close()
    except TelegramError as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุงุฑุณุงู ุนฺฉุณ ุจู ุงุฏูู {ADMIN_ID}: {e}")
        await update.message.reply_text(
            clean_text("ุงููพุณุ ูุดฺฉู ุฏุฑ ุงุฑุณุงู ูพุงู ูพุด ุงููุฏ! ๐ ูุทูุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    await update.message.reply_text("๐ฌ", parse_mode="Markdown")
    await update.message.reply_text(
        clean_text("ูุชู ุดูุง ุจุง ููููุช ุงุฑุณุงู ุดุฏ โ"),
        reply_markup=SUPPORT_KEYBOARD,
        parse_mode="Markdown"
    )

async def handle_support_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ูุฏููุง ุงุฑุณุงู ุฏุฑ ุญุงูุช ูพุดุชุจุงู"""
    user_id = update.effective_user.id
    message_id = update.message.message_id
    video = update.message.video
    caption = update.message.caption or "ุจุฏูู ฺฉูพุดู"
    username = update.message.from_user.username
    display_name = f"@{username}" if username else update.message.from_user.first_name
    display_id = f"@{username}" if username else str(user_id)

    is_member = await check_channel_membership(context.bot, user_id)
    if not is_member:
        welcome_message = clean_text(
            "ุงููพุณ! ๐ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฑุจุงุช ุจุงุฏ ุชู ฺฉุงูุงู ุนุถู ุจุด!\n"
            "ูุทูุงู ุชู ฺฉุงูุงู ุนุถู ุดู ู ุจุนุฏ ุฏฺฉูู *ุนุถู ุดุฏู* ุฑู ุจุฒู! ๐"
        )
        keyboard = [
            [InlineKeyboardButton("ุนุถู ฺฉุงูุงู ุดู ๐ข", url=CHANNEL_LINK)],
            [InlineKeyboardButton("ุนุถู ุดุฏู! โ", callback_data="check_membership")]
        ]
        await update.message.reply_text(
            welcome_message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )
        return

    if not await check_rate_limit(context, user_id):
        await update.message.reply_text(
            clean_text("ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉู! ๐ ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุชโูุงุช ุฒุงุฏ ุดุฏู."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
        Geometric mean: 0.0000
        return

    support_id = str(uuid.uuid4())
    timestamp = datetime.now().isoformat()

    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO support_messages (support_id, user_id, user_message_id, admin_message_id, message_text, timestamp)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (support_id, user_id, message_id, None, caption, timestamp))
    conn.commit()
    conn.close()

    admin_caption = clean_text(
        f"๐ฌ *ูพุงู ุฌุฏุฏ ุงุฒ ฺฉุงุฑุจุฑ*: {display_name}\n"
        f"๐ *ุขุฏ ฺฉุงุฑุจุฑ*: {display_id}\n\n"
        f"*ูุชู ูพุงู*:\n{caption}"
    )

    try:
        admin_message = await context.bot.send_video(
            chat_id=ADMIN_ID,
            video=video.file_id,
            caption=admin_caption,
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ูพุงุณุฎ", callback_data=f"reply_{support_id}")]
            ]),
            protect_content=True
        )
        conn = sqlite3.connect("bot.db")
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE support_messages SET admin_message_id = ? WHERE support_id = ?
        """, (admin_message.message_id, support_id))
        conn.commit()
        conn.close()
    except TelegramError as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุงุฑุณุงู ูุฏู ุจู ุงุฏูู {ADMIN_ID}: {e}")
        await update.message.reply_text(
            clean_text("ุงููพุณุ ูุดฺฉู ุฏุฑ ุงุฑุณุงู ูพุงู ูพุด ุงููุฏ! ๐ ูุทูุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    await update.message.reply_text("๐ฌ", parse_mode="Markdown")
    await update.message.reply_text(
        clean_text("ูุชู ุดูุง ุจุง ููููุช ุงุฑุณุงู ุดุฏ โ"),
        reply_markup=SUPPORT_KEYBOARD,
        parse_mode="Markdown"
    )

async def handle_support_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ูุงูโูุง ุงุฑุณุงู ุฏุฑ ุญุงูุช ูพุดุชุจุงู"""
    user_id = update.effective_user.id
    message_id = update.message.message_id
    document = update.message.document
    caption = update.message.caption or "ุจุฏูู ฺฉูพุดู"
    username = update.message.from_user.username
    display_name = f"@{username}" if username else update.message.from_user.first_name
    display_id = f"@{username}" if username else str(user_id)

    is_member = await check_channel_membership(context.bot, user_id)
    if not is_member:
        welcome_message = clean_text(
            "ุงููพุณ! ๐ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฑุจุงุช ุจุงุฏ ุชู ฺฉุงูุงู ุนุถู ุจุด!\n"
            "ูุทูุงู ุชู ฺฉุงูุงู ุนุถู ุดู ู ุจุนุฏ ุฏฺฉูู *ุนุถู ุดุฏู* ุฑู ุจุฒู! ๐"
        )
        keyboard = [
            [InlineKeyboardButton("ุนุถู ฺฉุงูุงู ุดู ๐ข", url=CHANNEL_LINK)],
            [InlineKeyboardButton("ุนุถู ุดุฏู! โ", callback_data="check_membership")]
        ]
        await update.message.reply_text(
            welcome_message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )
        return

    if not await check_rate_limit(context, user_id):
        await update.message.reply_text(
            clean_text("ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉู! ๐ ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุชโูุงุช ุฒุงุฏ ุดุฏู."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    support_id = str(uuid.uuid4())
    timestamp = datetime.now().isoformat()

    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO support_messages (support_id, user_id, user_message_id, admin_message_id, message_text, timestamp)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (support_id, user_id, message_id, None, caption, timestamp))
    conn.commit()
    conn.close()

    admin_caption = clean_text(
        f"๐ฌ *ูพุงู ุฌุฏุฏ ุงุฒ ฺฉุงุฑุจุฑ*: {display_name}\n"
        f"๐ *ุขุฏ ฺฉุงุฑุจุฑ*: {display_id}\n\n"
        f"*ูุชู ูพุงู*:\n{caption}"
    )

    try:
        admin_message = await context.bot.send_document(
            chat_id=ADMIN_ID,
            document=document.file_id,
            caption=admin_caption,
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ูพุงุณุฎ", callback_data=f"reply_{support_id}")]
            ]),
            protect_content=True
        )
        conn = sqlite3.connect("bot.db")
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE support_messages SET admin_message_id = ? WHERE support_id = ?
        """, (admin_message.message_id, support_id))
        conn.commit()
        conn.close()
    except TelegramError as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุงุฑุณุงู ูุงู ุจู ุงุฏูู {ADMIN_ID}: {e}")
        await update.message.reply_text(
            clean_text("ุงููพุณุ ูุดฺฉู ุฏุฑ ุงุฑุณุงู ูพุงู ูพุด ุงููุฏ! ๐ ูุทูุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    await update.message.reply_text("๐ฌ", parse_mode="Markdown")
    await update.message.reply_text(
        clean_text("ูุชู ุดูุง ุจุง ููููุช ุงุฑุณุงู ุดุฏ โ"),
        reply_markup=SUPPORT_KEYBOARD,
        parse_mode="Markdown"
    )

async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ฺฉูฺฉ ุฑู ุฏฺฉููโูุง ุงููุงู"""
    query = update.callback_query
    await query.answer()
    data = query.data

    if data == "check_membership":
        await check_membership(update, context)
    elif data.startswith("reply_"):
        support_id = data.split("_")[1]
        conn = sqlite3.connect("bot.db")
        cursor = conn.cursor()
        cursor.execute("SELECT user_id FROM support_messages WHERE support_id = ?", (support_id,))
        result = cursor.fetchone()
        conn.close()
        
        if result:
            user_id = result[0]
            context.user_data["support_id"] = support_id
            context.user_data["mode"] = "admin_reply"
            await query.message.reply_text(
                clean_text(f"ูุทูุงู ูพุงุณุฎ ุฎูุฏ ุฑุง ุจุฑุง ฺฉุงุฑุจุฑ {user_id} ูุงุฑุฏ ฺฉูุฏ:"),
                parse_mode="Markdown"
            )
        else:
            await query.message.reply_text(
                clean_text("ุงู ูพุงู ูพุดุชุจุงู ุฏฺฏุฑ ูุนุชุจุฑ ูุณุช! ๐"),
                parse_mode="Markdown"
            )

async def handle_admin_reply(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ูพุงุณุฎ ุงุฏูู ุจู ูพุงู ูพุดุชุจุงู"""
    user_id = update.effective_user.id
    if user_id != ADMIN_ID:
        return

    if context.user_data.get("mode") != "admin_reply" or "support_id" not in context.user_data:
        return

    support_id = context.user_data["support_id"]
    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, user_message_id FROM support_messages WHERE support_id = ?", (support_id,))
    result = cursor.fetchone()
    conn.close()

    if not result:
        await update.message.reply_text(
            clean_text("ุงู ูพุงู ูพุดุชุจุงู ุฏฺฏุฑ ูุนุชุจุฑ ูุณุช! ๐"),
            parse_mode="Markdown"
        )
        return

    target_user_id, user_message_id = result
    reply_text = update.message.text

    try:
        await context.bot.send_message(
            chat_id=target_user_id,
            text=clean_text(f"ูพุงุณุฎ ุงุฏูู:\n\n{reply_text}"),
            reply_to_message_id=user_message_id,
            parse_mode="Markdown",
            protect_content=True
        )
        await update.message.reply_text(
            clean_text("ูพุงุณุฎ ุดูุง ุจุง ููููุช ุจู ฺฉุงุฑุจุฑ ุงุฑุณุงู ุดุฏ! ๐"),
            parse_mode="Markdown"
        )
    except TelegramError as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุงุฑุณุงู ูพุงุณุฎ ุจู ฺฉุงุฑุจุฑ {target_user_id}: {e}")
        error_message = "ุฎุทุง ุฏุฑ ุงุฑุณุงู ูพุงุณุฎ ุจู ฺฉุงุฑุจุฑ! ๐ "
        if "chat not found" in str(e).lower():
            error_message += "ฺฉุงุฑุจุฑ ฺุช ุจุง ุฑุจุงุช ุฑุง ุดุฑูุน ูฺฉุฑุฏู ุงุณุช."
        elif "blocked by user" in str(e).lower():
            error_message += "ุฑุจุงุช ุชูุณุท ฺฉุงุฑุจุฑ ุจูุงฺฉ ุดุฏู ุงุณุช."
        else:
            error_message += "ูุทูุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉูุฏ."
        await update.message.reply_text(
            clean_text(error_message),
            parse_mode="Markdown"
        )
        return

    conn = sqlite3.connect("bot.db")
    cursor = conn.cursor()
    cursor.execute("DELETE FROM support_messages WHERE support_id = ?", (support_id,))
    conn.commit()
    conn.close()
    context.user_data.clear()

async def process_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูพุฑุฏุงุฒุด ูพุงูโูุง ูุชู ฺฉุงุฑุจุฑ"""
    user_id = update.effective_user.id
    message_text = update.message.text
    chat_id = update.message.chat_id
    username = update.message.from_user.username
    first_name = update.message.from_user.first_name
    
    # ุจูโุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
    await update_user_info(user_id, first_name, username)

    if user_id == ADMIN_ID and context.user_data.get("mode") == "admin_reply":
        await handle_admin_reply(update, context)
        return

    if message_text == "๐ ุจุงุฒฺฏุดุช":
        if user_id in AI_CHAT_USERS:
            AI_CHAT_USERS.remove(user_id)
        context.user_data.clear()
        await update.message.reply_text(
            clean_text("ุจู *ููู ุงุตู* ุจุฑฺฏุดุช! ๐ ฺฉ ุงุฒ ฺฏุฒููโูุง ุฑู ุงูุชุฎุงุจ ฺฉู:"),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    is_member = await check_channel_membership(context.bot, user_id)
    if not is_member:
        welcome_message = clean_text(
            "ุงููพุณ! ๐ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฑุจุงุช ุจุงุฏ ุชู ฺฉุงูุงู ุนุถู ุจุด!\n"
            "ูุทูุงู ุชู ฺฉุงูุงู ุนุถู ุดู ู ุจุนุฏ ุฏฺฉูู *ุนุถู ุดุฏู* ุฑู ุจุฒู! ๐"
        )
        keyboard = [
            [InlineKeyboardButton("ุนุถู ฺฉุงูุงู ุดู ๐ข", url=CHANNEL_LINK)],
            [InlineKeyboardButton("ุนุถู ุดุฏู! โ", callback_data="check_membership")]
        ]
        await update.message.reply_text(
            welcome_message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )
        return

    if not await check_rate_limit(context, user_id):
        await update.message.reply_text(
            clean_text("ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉู! ๐ ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุชโูุงุช ุฒุงุฏ ุดุฏู."),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )
        return

    if context.user_data.get("mode") == "support":
        await handle_support_message(update, context)
        return

    # ูุฏุฑุช ุฏฺฉููโูุง ููู ุงุตู
    MENU_ACTIONS = {
        "๐ฉบ ูุดุงูุฑู ูพุฒุดฺฉ": {"mode": "ai_chat", "message": "๐ค *ุฏุณุชุงุฑ ูพุฒุดฺฉ* ูุนุงู ุดุฏ!\n\nุณุคุงูุช ุฏุฑุจุงุฑู ุจูุงุฑ ุง ููุถูุน ูพุฒุดฺฉ ฺูุ\nูุซูุงู ุจูพุฑุณ: *ุณุฑูุงุฎูุฑุฏฺฏ ฺ ุจุฎูุฑูุ* ุง ุชุตูุฑ ุจูุฑุณุช! ๐"},
        "๐ง ุณูุงูุช ุฑูุงู": {"mode": "mental_health", "message": "๐ง *ุณูุงูุช ุฑูุงู ูุญุธูโุง* ูุนุงู ุดุฏ!\n\nุฏุฑุจุงุฑู ุญุงูุช ุจฺฏู ุง ุชุตูุฑ ุจูุฑุณุช!\nูุซูุงู: *ุงุณุชุฑุณ ุฏุงุฑูุ ฺฺฉุงุฑ ฺฉููุ* ๐"},
        "๐ฆท ุณูุงูุช ุฏูุงู ู ุฏูุฏุงู": {"mode": "dental_health", "message": "๐ฆท *ุณูุงูุช ุฏูุงู ู ุฏูุฏุงู* ูุนุงู ุดุฏ!\n\nุชุตูุฑ ุฏูุฏุงู ุจูุฑุณุช ุง ุนูุงุฆู ุฑู ุจฺฏู!\nูุซูุงู: *ุฏูุฏููู ุฏุฑุฏ ูโฺฉููุ ฺฺฉุงุฑ ฺฉููุ* ๐"},
        "๐งช ุจุฑุฑุณ ุขุฒูุงุด": {"mode": "lab_test", "message": "๐งช *ุจุฑุฑุณ ุขุฒูุงุด* ูุนุงู ุดุฏ!\n\nุชุตูุฑ ุจุฑฺฏู ุขุฒูุงุด ุจูุฑุณุช ุง ุณุคุงูุช ุฑู ุจฺฏู!\nูุซูุงู: *ููุฏ ุฎูู 150 ุนู ฺุ* ๐"},
        "๐ ุชุญูู ููุงุฑ ููุจ": {"mode": "ecg", "message": "๐ *ุชุญูู ููุงุฑ ููุจ* ูุนุงู ุดุฏ!\n\nุชุตูุฑ ููุงุฑ ููุจ ุจูุฑุณุช ุง ุณุคุงูุช ุฑู ุจฺฏู!\nูุซูุงู: *ุฑุชู ูุงููุธู ุนู ฺุ* ๐"},
        "๐ฉป ุชูุณุฑ ุฑุงุฏูููฺ": {"mode": "radiology", "message": "๐ฉป *ุชูุณุฑ ุฑุงุฏูููฺ* ูุนุงู ุดุฏ!\n\nุชุตูุฑ ุฑุงุฏูููฺ (ูุซู X-ray) ุจูุฑุณุช ุง ุณุคุงูุช ุฑู ุจฺฏู!\nูุซูุงู: *ุงู ุณุงู ุชู X-ray ฺูุ* ๐"},
        "๐งซ ุชุดุฎุต ุนูุงุฆู": {"mode": "symptom_diagnosis", "message": "๐งซ *ุชุดุฎุต ุนูุงุฆู* ูุนุงู ุดุฏ!\n\nุนูุงุฆูุช ุฑู ุจฺฏู ุง ุชุตูุฑ (ูุซู ูฺฉ ูพูุณุช) ุจูุฑุณุช!\nูุซูุงู: *ุฏู ุฑูุฒู ุชุจ ุฏุงุฑู ู ุณุฑูู ูโฺฉููุ ฺูุ* ๐"},
        "๐ ุดูุงุณุง ุฏุงุฑููุง": {"mode": "drug_identification", "message": "๐ *ุดูุงุณุง ุฏุงุฑููุง* ูุนุงู ุดุฏ!\n\nุชุตูุฑ ูุฑุต ุง ุฌุนุจู ุจูุฑุณุชุ ุง ุณุคุงูุช ุฑู ุจฺฏู!\nูุซูุงู: *ุนูุงุฑุถ ุขุณูพุฑู ฺูุ* ๐"},
        "๐ฉน ูุฑุงูุจุช ุงุฒ ุฒุฎู": {"mode": "wound_care", "message": "๐ฉน *ูุฑุงูุจุช ุงุฒ ุฒุฎู* ูุนุงู ุดุฏ!\n\nุชุตูุฑ ุฒุฎู ุจูุฑุณุช ุง ุนูุงุฆู ุฑู ุจฺฏู!\nูุซูุงู: *ุฒุฎูู ูุฑูุฒ ุดุฏูุ ฺฺฉุงุฑ ฺฉููุ* ๐"},
        "๐ ุดุงุฎุต ุชูุฏู ุจุฏู": {"mode": "bmi", "message": "๐ *ุดุงุฎุต ุชูุฏู ุจุฏู* ูุนุงู ุดุฏ!\n\nูุฏ ู ูุฒู ุฎูุฏุช ุฑู ุจฺฏู!\nูุซูุงู: *170 ุณุงูุชโูุชุฑุ 70 ฺฉููฺฏุฑู* ๐"},
    }

    if message_text in MENU_ACTIONS:
        AI_CHAT_USERS.add(user_id)
        context.user_data.clear()
        context.user_data["mode"] = MENU_ACTIONS[message_text]["mode"]
        await update.message.reply_text(
            clean_text(MENU_ACTIONS[message_text]["message"]),
            reply_markup=SUB_MENU_KEYBOARD,
            parse_mode="Markdown"
        )
    elif message_text == "๐งฐ ุฌุนุจู ุงุจุฒุงุฑ ูพุฒุดฺฉ":
        await update.message.reply_text(
            clean_text(
                "๐งฐ *ุฌุนุจู ุงุจุฒุงุฑ ูพุฒุดฺฉ* ุจุงุฒ ุดุฏ!\n\n"
                "ฺฉ ุงุฒ ุงุจุฒุงุฑูุง ุฒุฑ ุฑู ุงูุชุฎุงุจ ฺฉู:"
            ),
            reply_markup=TOOLBOX_MENU_KEYBOARD,
            parse_mode="Markdown"
        )
    elif message_text == "โ๏ธ ุฑุงูููุง":
        guide_message = clean_text(
            "๐ *ุฑุงูููุง ุงุณุชูุงุฏู ุงุฒ ุฏุณุชุงุฑ ูพุฒุดฺฉ*:\n\n"
            "- **ูุดุงูุฑู ูพุฒุดฺฉ ๐ฉบ**: ุฏุฑุจุงุฑู ุจูุงุฑโูุง ุง ุนูุงุฆู ุณุคุงู ฺฉู.\n"
            "- **ุณูุงูุช ุฑูุงู ๐ง**: ุฏุฑุจุงุฑู ุงุณุชุฑุณ ุง ุฑูุญุงุช ุจฺฏู.\n"
            "- **ุณูุงูุช ุฏูุงู ู ุฏูุฏุงู ๐ฆท**: ุชุตูุฑ ุฏูุฏุงู ุง ุนูุงุฆู ุจูุฑุณุช.\n"
            "- **ุฌุนุจู ุงุจุฒุงุฑ ูพุฒุดฺฉ ๐งฐ**:\n"
            "  - *ุชุดุฎุต ุนูุงุฆู ๐งซ*: ุนูุงุฆู ุง ุชุตูุฑ ุจูุฑุณุช ุจุฑุง ุชุดุฎุต.\n"
            "  - *ุจุฑุฑุณ ุขุฒูุงุด ๐งช*: ุจุฑฺฏู ุขุฒูุงุด ุจูุฑุณุช ุง ุณุคุงู ฺฉู.\n"
            "  - *ุชุญูู ููุงุฑ ููุจ ๐*: ุชุตูุฑ ููุงุฑ ููุจ ุจูุฑุณุช.\n"
            "  - *ุชูุณุฑ ุฑุงุฏูููฺ ๐ฉป*: ุชุตูุฑ X-ray ุง CT ุจูุฑุณุช.\n"
            "  - *ุดูุงุณุง ุฏุงุฑููุง ๐*: ุชุตูุฑ ูุฑุต ุง ุณุคุงู ุฏุงุฑู ุจูุฑุณุช.\n"
            "  - *ูุฑุงูุจุช ุงุฒ ุฒุฎู ๐ฉน*: ุชุตูุฑ ุฒุฎู ุง ุนูุงุฆู ุจูุฑุณุช.\n"
            "  - *ุดุงุฎุต ุชูุฏู ุจุฏู ๐*: ูุฏ ู ูุฒู ุฑู ุจฺฏู ุชุง BMI ูุญุงุณุจู ุจุดู.\n"
            "- **ูพุดุชุจุงู ๐ฌ**: ุจุฑุง ุณุคุงูุงุช ุฏฺฏูุ ูุชูุ ุนฺฉุณุ ูุฏู ุง ูุงู ุจูุฑุณุช.\n\n"
            "*ููุดู ุจุฑุง ุชุดุฎุต ุง ุฏุฑูุงู ุจุง ูพุฒุดฺฉ ูุดูุฑุช ฺฉู!* ๐ฉบ\n"
            "ุณุคุงู ุฏุงุฑุ ฺฉ ุงุฒ ฺฏุฒููโูุง ุฑู ุงูุชุฎุงุจ ฺฉู! ๐"
        )
        await update.message.reply_text(
            guide_message,
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )
    elif message_text == "๐ฌ ูพุดุชุจุงู":
        AI_CHAT_USERS.add(user_id)
        context.user_data.clear()
        context.user_data["mode"] = "support"
        await update.message.reply_text(
            clean_text(
                "๐ฌ *ูพุดุชุจุงู ุฏุณุชุงุฑ ูพุฒุดฺฉ*\n\n"
                "ุณุคุงูุช ุฑู ุจููุณ ุง ุนฺฉุณุ ูุฏู ู ูุงู ุจูุฑุณุช! ๐\n"
                "ูุง ุจูโุฒูุฏ ุฌูุงุจุช ุฑู ูโุฏู."
            ),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
    elif user_id in AI_CHAT_USERS and context.user_data.get("mode") in SYSTEM_MESSAGES.keys():
        message_id = update.message.message_id
        with PROCESSING_LOCK:
            if message_id in PROCESSED_MESSAGES:
                logger.warning(f"ูพุงู ุชฺฉุฑุงุฑ ุจุง message_id: {message_id} - ูุงุฏุฏู ฺฏุฑูุชู ุดุฏ")
                return
            PROCESSED_MESSAGES.add(message_id)

        user_message = update.message.text
        await save_chat_history(user_id, "user", user_message)
        chat_history = await get_chat_history(user_id)

        system_message = SYSTEM_MESSAGES.get(context.user_data["mode"], SYSTEM_MESSAGES["ai_chat"])

        temp_message = await update.message.reply_text("๐ฉบ", parse_mode="Markdown")

        payload = {
            "model": "openai-large",
            "messages": [
                {"role": "system", "content": system_message}
            ] + chat_history,
            "max_tokens": 300,
            "seed": 42,
            "json_mode": False
        }

        for attempt in range(2):
            try:
                response = requests.post(TEXT_API_URL, json=payload, timeout=20)
                try:
                    await context.bot.delete_message(chat_id=chat_id, message_id=temp_message.message_id)
                except TelegramError as e:
                    logger.error(f"ุฎุทุง ุฏุฑ ุญุฐู ูพุงู ูููุช: {e}")

                if response.status_code == 200:
                    response_data = response.json()
                    ai_response = response_data.get("choices", [{}])[0].get("message", {}).get("content", "ูพุงุณุฎ ุฏุฑุงูุช ูุดุฏ!")
                    ai_response = clean_text(ai_response.strip())
                    await save_chat_history(user_id, "assistant", ai_response)
                    await update.message.reply_text(
                        ai_response,
                        reply_markup=SUB_MENU_KEYBOARD,
                        parse_mode="Markdown"
                    )
                    break
                else:
                    await update.message.reply_text(
                        clean_text("ุงููพุณุ *ุณุณุชู ูพุฒุดฺฉโููู* ู ูุญุธู ููู ฺฉุฑุฏ! ๐ฉบ ูุทูุงู ุฏูุจุงุฑู ุณุคุงูุช ุฑู ุจูุฑุณุช. ๐"),
                        reply_markup=SUB_MENU_KEYBOARD,
                        parse_mode="Markdown"
                    )
                    break
            except requests.exceptions.RequestException as e:
                logger.error(f"ุฎุทุง ุฏุฑ ุงุชุตุงู ุจู API ฺุช (ุชูุงุด {attempt + 1}): {e}")
                if attempt == 1:
                    try:
                        await context.bot.delete_message(chat_id=chat_id, message_id=temp_message.message_id)
                    except TelegramError as e:
                        logger.error(f"ุฎุทุง ุฏุฑ ุญุฐู ูพุงู ูููุช: {e}")
                    await update.message.reply_text(
                        clean_text("ุงููุ *ุงุจุฒุงุฑ ุชุดุฎุตโููู* ูุงุฒ ุจู ุจุฑุฑุณ ุฏุงุฑู! ๐ ูุทูุงู ุฏูุจุงุฑู ุณุคุงูุช ุฑู ุจูุฑุณุช. ๐"),
                        reply_markup=SUB_MENU_KEYBOARD,
                        parse_mode="Markdown"
                    )
    else:
        await update.message.reply_text(
            clean_text("ูุทูุงู ฺฉ ุงุฒ ฺฏุฒููโูุง *ููู* ุฑู ุงูุชุฎุงุจ ฺฉู! ๐"),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุงูุฒูุฏู ูพุงู ุจู ุตู ุจุฑุง ูพุฑุฏุงุฒุด"""
    await MESSAGE_QUEUE.put((update, context))

async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ุนฺฉุณโูุง ุงุฑุณุงู"""
    user_id = update.effective_user.id
    mode = context.user_data.get("mode")
    username = update.message.from_user.username
    first_name = update.message.from_user.first_name
    
    # ุจูโุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
    await update_user_info(user_id, first_name, username)

    if mode == "support":
        await handle_support_photo(update, context)
    elif user_id in AI_CHAT_USERS and mode in SYSTEM_MESSAGES.keys():
        if not await check_rate_limit(context, user_id):
            await update.message.reply_text(
                clean_text("ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉู! ๐ ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุชโูุงุช ุฒุงุฏ ุดุฏู."),
                reply_markup=MAIN_MENU_KEYBOARD,
                parse_mode="Markdown"
            )
            return

        message_id = update.message.message_id
        with PROCESSING_LOCK:
            if message_id in PROCESSED_MESSAGES:
                logger.warning(f"ูพุงู ุชฺฉุฑุงุฑ ุจุง message_id: {message_id} - ูุงุฏุฏู ฺฏุฑูุชู ุดุฏ")
                return
            PROCESSED_MESSAGES.add(message_id)

        async with REQUEST_SEMAPHORE:
            chat_id = update.message.chat_id
            temp_message = await update.message.reply_text("๐ฌ", parse_mode="Markdown")

            photo = update.message.photo[-1]
            file = await context.bot.get_file(photo.file_id)
            file_url = file.file_path

            caption = update.message.caption if update.message.caption else "ุงู ุชุตูุฑ ฺูุ ุจูโุตูุฑุช ุฎูุงุตู ู ุฏูู ุชุญูู ฺฉู! ๐ฉบ"

            image_message = {
                "role": "user",
                "content": [
                    {"type": "text", "text": caption},
                    {"type": "image_url", "image_url": {"url": file_url}}
                ]
            }
            await save_chat_history(user_id, "user", str(image_message))
            chat_history = await get_chat_history(user_id)

            system_message = SYSTEM_MESSAGES[mode]

            payload = {
                "model": "openai-large",
                "messages": [
                    {"role": "system", "content": system_message}
                ] + chat_history,
                "max_tokens": 300,
                "seed": 42,
                "json_mode": False
            }

            for attempt in range(2):
                try:
                    response = requests.post(TEXT_API_URL, json=payload, timeout=20)
                    try:
                        await context.bot.delete_message(chat_id=chat_id, message_id=temp_message.message_id)
                    except TelegramError as e:
                        logger.error(f"ุฎุทุง ุฏุฑ ุญุฐู ูพุงู ูููุช: {e}")

                    if response.status_code == 200:
                        response_data = response.json()
                        ai_response = response_data.get("choices", [{}])[0].get("message", {}).get("content", "ูพุงุณุฎ ุฏุฑุงูุช ูุดุฏ!")
                        ai_response = clean_text(ai_response.strip())
                        await save_chat_history(user_id, "assistant", ai_response)
                        await update.message.reply_text(
                            ai_response,
                            reply_markup=SUB_MENU_KEYBOARD,
                            parse_mode="Markdown"
                        )
                        break
                    else:
                        await update.message.reply_text(
                            clean_text("ุงููุ *ุฏุณุชฺฏุงู ุชุญููโููู* ูุงุฒ ุจู ุชูุธู ุฏุงุฑู! ๐ ูุทูุงู ุฏูุจุงุฑู ุนฺฉุณ ุฑู ุจูุฑุณุช. ๐ฉป"),
                            reply_markup=SUB_MENU_KEYBOARD,
                            parse_mode="Markdown"
                        )
                        break
                except requests.exceptions.RequestException as e:
                    logger.error(f"ุฎุทุง ุฏุฑ ุชุญูู ุชุตูุฑ (ุชูุงุด {attempt + 1}): {e}")
                    if attempt == 1:
                        try:
                            await context.bot.delete_message(chat_id=chat_id, message_id=temp_message.message_id)
                        except TelegramError as e:
                            logger.error(f"ุฎุทุง ุฏุฑ ุญุฐู ูพุงู ูููุช: {e}")
                        await update.message.reply_text(
                            clean_text("ุงููพุณุ *ุงุณฺฉูุฑ ูพุฒุดฺฉโููู* ู ูุญุธู ุฎุงููุด ุดุฏ! ๐ฉบ ูุทูุงู ุฏูุจุงุฑู ุนฺฉุณ ุฑู ุจูุฑุณุช. ๐"),
                            reply_markup=SUB_MENU_KEYBOARD,
                            parse_mode="Markdown"
                        )
    else:
        await update.message.reply_text(
            clean_text("ูุทูุงู ุจุฑุง ุชุญูู ุชุตูุฑุ ฺฏุฒูู ูุฑุชุจุท ุฑู ุงุฒ *ููู* ุงูุชุฎุงุจ ฺฉู! ๐"),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )

async def handle_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ูุฏููุง ุงุฑุณุงู"""
    user_id = update.effective_user.id
    mode = context.user_data.get("mode")
    username = update.message.from_user.username
    first_name = update.message.from_user.first_name
    
    # ุจูโุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
    await update_user_info(user_id, first_name, username)

    if mode == "support":
        await handle_support_video(update, context)
    else:
        await update.message.reply_text(
            clean_text("ุงุฑุณุงู ูุฏู ููุท ุฏุฑ ุจุฎุด *ูพุดุชุจุงู ๐ฌ* ููฺฉูู! ๐ ูุทูุงู ฺฏุฒูู ูพุดุชุจุงู ุฑู ุงูุชุฎุงุจ ฺฉู."),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )

async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ูุงูโูุง ุงุฑุณุงู"""
    user_id = update.effective_user.id
    mode = context.user_data.get("mode")
    username = update.message.from_user.username
    first_name = update.message.from_user.first_name
    
    # ุจูโุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
    await update_user_info(user_id, first_name, username)

    if mode == "support":
        await handle_support_document(update, context)
    else:
        await update.message.reply_text(
            clean_text("ุงุฑุณุงู ูุงู ููุท ุฏุฑ ุจุฎุด *ูพุดุชุจุงู ๐ฌ* ููฺฉูู! ๐ ูุทูุงู ฺฏุฒูู ูพุดุชุจุงู ุฑู ุงูุชุฎุงุจ ฺฉู."),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )

async def handle_forwarded_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุฌููฺฏุฑ ุงุฒ ูพุฐุฑุด ูพุงูโูุง ููุฑูุงุฑุฏุดุฏู"""
    user_id = update.effective_user.id
    mode = context.user_data.get("mode")
    username = update.message.from_user.username
    first_name = update.message.from_user.first_name
    
    # ุจูโุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
    await update_user_info(user_id, first_name, username)

    if mode == "support":
        await update.message.reply_text(
            clean_text("ุงุฑุณุงู ูพุงู ููุฑูุงุฑุฏุดุฏู ูุฌุงุฒ ูุณุช! ๐ ูุทูุงู ูพุงูุ ุนฺฉุณุ ูุฏู ุง ูุงู ุฎูุฏุช ุฑู ุจูุฑุณุช."),
            reply_markup=SUPPORT_KEYBOARD,
            parse_mode="Markdown"
        )
    else:
        await update.message.reply_text(
            clean_text("ูุทูุงู ฺฉ ุงุฒ ฺฏุฒููโูุง *ููู* ุฑู ุงูุชุฎุงุจ ฺฉู! ๐"),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )

async def message_worker():
    """ฺฉุงุฑฺฏุฑ ุจุฑุง ูพุฑุฏุงุฒุด ูพุงูโูุง ุงุฒ ุตู"""
    while True:
        update, context = await MESSAGE_QUEUE.get()
        try:
            async with REQUEST_SEMAPHORE:
                await process discerned_message(update, context)
        except Exception as e:
            logger.error(f"ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ูพุงู ุงุฒ ุตู: {e}")
        finally:
            MESSAGE_QUEUE.task_done()

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุฏุฑุช ุฎุทุงูุง"""
    logger.error(f"ุฎุทุง ุฑุฎ ุฏุงุฏ: {context.error}")
    error_message = "ุงููพุณุ *ุณุณุชู ฺฉููฺฉโููู* ู ูุญุธู ูุทุน ุดุฏ! ๐ฉป ูุทูุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู. ๐"
    
    if isinstance(context.error, NetworkError):
        error_message = "ูุดฺฉู *ุงุชุตุงู ุจู ุดุจฺฉู* ุฏุงุฑู! ๐ ูุทูุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู. ๐"
    elif isinstance(context.error, TimedOut):
        error_message = "ุฏุฑุฎูุงุณุช *ุจุด ุงุฒ ุญุฏ ุทูู ฺฉุดุฏ*! โณ ูุทูุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู. ๐"
    
    if update and hasattr(update, 'message') and update.message:
        await update.message.reply_text(
            clean_text(error_message),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )
    elif update and hasattr(update, 'callback_query') and update.callback_query:
        await update.callback_query.message.reply_text(
            clean_text(error_message),
            reply_markup=MAIN_MENU_KEYBOARD,
            parse_mode="Markdown"
        )

async def main():
    """ุฑุงูโุงูุฏุงุฒ ุฑุจุงุช ุจุง ูุจโููฺฉ ู ุณุฑูุฑ FastAPI"""
    global application
    init_db()
    try:
        application = Application.builder().token(TOKEN).read_timeout(60).write_timeout(60).connect_timeout(60).build()
        await application.bot.set_webhook(url=WEBHOOK_URL)
        logger.info(f"Webhook ุฑู {WEBHOOK_URL} ุชูุธู ุดุฏ.")

        application.add_handler(CommandHandler("start", start, filters=filters.ChatType.PRIVATE))
        application.add_handler(CallbackQueryHandler(handle_callback_query))
        application.add_handler(MessageHandler(
            filters.TEXT & ~filters.COMMAND & filters.ChatType.PRIVATE,
            handle_message
        ))
        application.add_handler(MessageHandler(filters.PHOTO & filters.ChatType.PRIVATE, handle_photo))
        application.add_handler(MessageHandler(filters.VIDEO & filters.ChatType.PRIVATE, handle_video))
        application.add_handler(MessageHandler(filters.Document.ALL & filters.ChatType.PRIVATE, handle_document))
        application.add_handler(MessageHandler(filters.FORWARDED & filters.ChatType.PRIVATE, handle_forwarded_message))
        application.add_error_handler(error_handler)

        logger.info("ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ ุฑุจุงุช...")
        await application.initialize()
        logger.info("ุฏุฑ ุญุงู ุดุฑูุน ุฑุจุงุช...")
        await application.start()

        asyncio.create_task(message_worker())
        asyncio.create_task(cleanup_old_messages())

        config = uvicorn.Config(app, host="0.0.0.0", port=8000)
        server = uvicorn.Server(config)
        await server.serve()

    except Exception as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุฑุงูโุงูุฏุงุฒ ุฑุจุงุช: {e}")
        raise

if __name__ == "__main__":
    asyncio.run(main())
